Bootstrap: docker
From: almalinux:9

%labels
    Maintainer Mat3ra.com
    Version nanolabo-mattersim-3.1-0

%help
    NanoLabo LAMMPS + MatterSim (requires CUDA installation mapped from the host)
    Example command:
    apptainer exec --nv nanolabo-mattersim.sif lammps_gnnp -i lammps.in

%environment
    export PATH=/opt/AdvanceSoft/NanoLabo/exec.LINUX/lammps_parallel:/opt/AdvanceSoft/NanoLabo/exec.LINUX/neuralmd:/opt/AdvanceSoft/NanoLabo/exec.LINUX/qe_parallel:/opt/mattersim/bin:$PATH
    export LD_LIBRARY_PATH=/opt/AdvanceSoft/NanoLabo/exec.LINUX/mpi/lib:/opt/mattersim/lib:$LD_LIBRARY_PATH
    export OPAL_PREFIX=/opt/AdvanceSoft/NanoLabo/exec.LINUX/mpi
    export PYTHONPATH=/opt/AdvanceSoft/NanoLabo/gnnp:/opt/mattersim/lib/python3.11/site-packages
    export LD_PRELOAD=/opt/mattersim/lib/libgomp.so
    export PYTHONHOME=/opt/mattersim

%post
    dnf in -y wget

    wget -q https://www.apps.advancesoft.jp/nanolabo/install_nanolabo_tool_linux_v3.1.bin
    #  oras pull ghcr.io/exabyte-io/application-containers-public/install_nanolabo_tool_linux:3.1
    chmod +x install_nanolabo_tool_linux_v3.1.bin

    echo -e "\n\n\n\n\n\nY\n\n\n\n\n" | script -qefc "./install_nanolabo_tool_linux_v3.1.bin"
    rm -f install_nanolabo_tool_linux_v3.1.bin

    wget -q https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash Miniconda3-latest-Linux-x86_64.sh -b -p /opt/miniconda3
    rm -f Miniconda3-latest-Linux-x86_64.sh

    source /opt/miniconda3/bin/activate

    # create env for mattersim with python 3.11
    CONDA_PLUGINS_AUTO_ACCEPT_TOS=yes conda create -p /opt/mattersim python=3.11 -y
    conda activate /opt/mattersim

    # need torch-dftd for DFT-D3 correction
    pip install --no-cache-dir mattersim torch-dftd

    find /opt/mattersim/lib/python3.11 -type d -name "__pycache__" -exec rm -rf {} +
    dnf clean all && rm -rf /var/lib/dnf /var/cache/dnf /var/cache/yum
